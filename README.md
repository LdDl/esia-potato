# ESIA oAuth –∫–ª–∏–µ–Ω—Ç –Ω–∞ Go

–î–≤–µ –≤–µ—Ä—Å–∏–∏ README:

üá∑üá∫ [–†—É—Å—Å–∫–∏–π](README.md) | üá∫üá∏ [English](README_en.md)

–ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é oAuth —á–µ—Ä–µ–∑ –ï–°–ò–ê —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ –ì–û–°–¢.
–ë–µ–∑ –≥–æ—Ç–æ–≤—ã—Ö Docker —Å–±–æ—Ä–æ–∫ —Å –ø—Ä–æ–ø–∞—Ç—á–µ–Ω–Ω—ã–º OpenSSL –∏–ª–∏ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç OpenSSL –∫–∞–∫ —Ç–∞–∫–æ–≤–æ–≥–æ.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–ß—Ç–æ —É–º–µ–µ—Ç](#—á—Ç–æ-—É–º–µ–µ—Ç)
- [–í–≤–æ–¥–Ω—ã–µ](#–≤–≤–æ–¥–Ω—ã–µ)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ](#–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ-–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ-–∫–ª—é—á–∞-–∏–∑-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞-–∫—Ä–∏–ø—Ç–æ–ø—Ä–æ)
- [–ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –ï–°–ò–ê](#–ø—Ä–∏–º–µ—Ä-–∫–ª–∏–µ–Ω—Ç–∞-–µ—Å–∏–∞)

## –ß—Ç–æ —É–º–µ–µ—Ç

- –ü–æ–¥–ø–∏—Å—å –ì–û–°–¢ –† 34.10-2012 (256 –±–∏—Ç)
- –•–µ—à –ì–û–°–¢ –† 34.11-2012 (–°—Ç—Ä–∏–±–æ–≥-256)
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ CMS/PKCS#7 SignedData
- –†–∞–±–æ—Ç–∞ —Å –∫–ª—é—á–∞–º–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ

## –í–≤–æ–¥–Ω—ã–µ

- –î–ª—è —Å–±–æ—Ä–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –Ω—É–∂–µ–Ω Go 1.21+
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ —Å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä" - —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–∏–ª–∏ –∞—Ä—Ö–∏–≤ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ), –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –∫–ª—é—á–∞ –∏–∑ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ CSP.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
esia-potato/
|--- cms/
|    --- cms.go                   # CMS/PKCS#7 SignedData
|--- cryptopro/
|    --- extract.go               # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–π
|--- utils/
|    --- bytes.go                 # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
|--- cmd/
|    |--- cryptopro_extract/
|    |    --- main.go             # CLI –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–π
|    `--- example/
|         --- main.go             # –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –ï–°–ò–ê
`--- test_container/              # –¢–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏. –í gitignore, —Ç–∞–∫ –∫–∞–∫ –≤–∞—à–∏ –±—É–¥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

* –î–ª—è —É—Ç–∏–ª–∏—Ç—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–π –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ
- –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä–æ—Å—Ç–æ CLI:
  ```bash
  go install github.com/LdDl/esia-potato/cmd/cryptopro_extract@latest
  cryptopro_extract -h
  ```

- –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–æ–±—Ä–∞—Ç—å –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤:
  ```bash
  git clone git@github.com:LdDl/esia-potato.git --depth 1
  cd esia-potato
  go run ./cmd/cryptopro_extract -h
  ```

## –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ —Ö—Ä–∞–Ω–∏—Ç –∫–ª—é—á–∏ –≤ –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º [–ì–û–°–¢ 28147](https://ru.wikipedia.org/wiki/%D0%93%D0%9E%D0%A1%D0%A2_28147-89).

- –° –ø–æ–º–æ—â—å—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ CLI:
  ```bash
  cryptopro_extract -p –ü–ò–ù_–ö–û–î_–ü–ê–†–û–õ–¨ ./container.000
  ```

- –ò–ª–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤:
  ```bash
  go run ./cmd/cryptopro_extract -p –ü–ò–ù_–ö–û–î_–ü–ê–†–û–õ–¨ ./container.000
  ```

–ï—Å–ª–∏ –≤—Å—ë –û–ö, —Ç–æ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—É–¥–µ—Ç —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞:

```
{"time":"2025-12-29T20:36:00.591340886+03:00","level":"INFO","msg":"container opened","path":"./test_container","curve_oid":"1.2.643.2.2.36.0"}
{"time":"2025-12-29T20:36:01.065829042+03:00","level":"INFO","msg":"primary key extracted","curve_oid":"1.2.643.2.2.36.0","fingerprint":"0123456789abcdef","private_key":"a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2"}
{"time":"2025-12-29T20:36:01.065854001+03:00","level":"WARN","msg":"secondary key found but not extracted","masks":"masks2.key","primary":"primary2.key"}
{"time":"2025-12-29T20:36:01.065858097+03:00","level":"INFO","msg":"done"}
```

–ï—Å–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º:
```
secondary key found but not extracted
````
, —Ç–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –≤—Ç–æ—Ä–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø–æ–¥–ø–∏—Å–∏, —Ç.–∫. –¥–ª—è oAuth –≤ –ï–°–ò–ê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á.

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ï–°–ò–ê.

## –ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –ï–°–ò–ê

- –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ `cmd/example/main.go` –≤ `keyHex`.
- –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–º–µ—Ä:
  ```bash
  go run ./cmd/example/main.go
  ```

–ï—Å–ª–∏ –≤—Å—ë –û–ö, —Ç–æ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—É–¥–µ—Ç —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞:
```
{"time":"2025-12-29T20:47:23.876107574+03:00","level":"INFO","msg":"message prepared","message":"openid2025.12.29 17:47:23 +0000775607_DP0f9439ef-3581-4de5-9b8c-d20135960331"}
{"time":"2025-12-29T20:47:23.878111012+03:00","level":"INFO","msg":"signature created","signature_bytes":2927,"base64_chars":3904}
{"time":"2025-12-29T20:47:23.8781677+03:00","level":"INFO","msg":"authorization URL prepared","url":"https://esia-portal1.test.gosuslugi.ru/aas/oauth2/ac?access_type=offline&client_id=775607_DP&client_secret=–≥–∏–≥–∞–Ω—Ç—Å–∫–∏–π_jwt_—Ç–æ–∫–µ–Ω&redirect_uri=https%3A%2F%2Fya.ru&response_type=code&scope=openid&state=0f9439ef-3581-4de5-9b8c-d20135960331&timestamp=2025.12.29+17%3A47%3A23+%2B0000"}
{"time":"2025-12-29T20:47:23.878185114+03:00","level":"INFO","msg":"testing against ESIA"}
{"time":"2025-12-29T20:47:23.95390256+03:00","level":"INFO","msg":"response received","status":"302 ","location":"https://esia-portal1.test.gosuslugi.ru/login"}
{"time":"2025-12-29T20:47:23.953918261+03:00","level":"INFO","msg":"signature accepted by ESIA"}
```

–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–¥–ø–∏—Å—å –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –≤—Å—ë –æ–∫.
